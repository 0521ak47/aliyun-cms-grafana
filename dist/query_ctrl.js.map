{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","GenericDatasourceQueryCtrl","$scope","$injector","scope","target","type","ycol","describe","xcol","project","metric","period","group","dimensions","statistics","query","checkIsNull","datasource","metricFindQuery","getProject","getMetrics","getPeriod","getStatistics","_","includes","push","panelCtrl","refresh","i","indexOf","splice","getGroups","getDimensions","dimension","rawQuery","re","RegExp","test","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!'\n\nexport class GenericDatasourceQueryCtrl extends QueryCtrl {\n\n  constructor($scope, $injector)  {\n    super($scope, $injector);\n    this.scope = $scope;\n    this.target.type = this.target.type || 'timeserie';\n    this.target.target = this.target.ycol;\n    this.target.describe = this.target.describe;\n    this.target.xcol = this.target.xcol || 'timestamp';\n    this.target.project = this.target.project || 'acs_ecs_dashboard';\n    this.target.metric = this.target.metric;\n    this.target.period = this.target.period;\n    this.target.group = this.target.group;\n    this.target.dimensions = this.target.dimensions || [];\n    this.dimensions;\n    \n    this.target.ycol = this.target.ycol || [];\n    this.statistics;\n\n  }\n\n  getOptions(query) {\n    this.checkIsNull();\n    return this.datasource.metricFindQuery(query || '');\n  }\n\n  getProjects() {\n    this.checkIsNull();\n    return this.datasource.getProject();\n  }\n\n  getMetrics() {\n    this.checkIsNull();\n    if(this.target.project){\n      return this.datasource.getMetrics(this.target.project);\n    }\n  }\n\n  getPeriod() {\n    this.checkIsNull();\n    if(this.target.project && this.target.metric){\n      return this.datasource.getPeriod(this.target.project,this.target.metric);\n    }\n  }\n\n  getStatistics() {\n    this.checkIsNull();\n    if(this.target.project && this.target.metric){\n      return this.datasource.getStatistics(this.target.project,this.target.metric,this.target.ycol);\n    }\n  }\n\n  ycolPush(ycol){\n    this.checkIsNull();\n    if(!ycol || _.includes(this.target.ycol, ycol)) {\n        return;\n    }\n    this.target.ycol.push(ycol);\n    this.statistics = \"\";\n    this.panelCtrl.refresh();\n  }\n\n  ycolSplice(ycol){\n    this.checkIsNull();\n    if(!ycol || !_.includes(this.target.ycol, ycol)) {\n        return;\n    }\n    let i = this.target.ycol.indexOf(ycol)\n    this.target.ycol.splice(i,1);\n    this.statistics = \"\";\n    this.panelCtrl.refresh(); \n  }\n\n  getGroups() {\n    this.checkIsNull();\n    return this.datasource.getGroups();\n  }\n\n  getDimensions() {\n    this.checkIsNull();\n    if(this.target.project && this.target.metric){\n      return this.datasource.getDimensions(this.target.project,this.target.metric,this.target.group,this.target.dimensions,this.target.period);\n    }\n  }\n\n  dimensionsPush(dimension){\n    this.checkIsNull();\n    if(!dimension || _.includes(this.target.dimensions, dimension)) {\n        return;\n    }\n    this.target.dimensions.push(dimension);\n    this.dimensions = \"\";\n    this.panelCtrl.refresh();\n  }\n\n  dimensionsSplice(dimension){\n    this.checkIsNull();\n    if(!dimension || !_.includes(this.target.dimensions, dimension)) {\n        return;\n    }\n    let i = this.target.dimensions.indexOf(dimension)\n    this.target.dimensions.splice(i,1);\n    this.dimensions = \"\";\n    this.panelCtrl.refresh(); \n  }\n\n  toggleEditorMode() {\n    this.target.rawQuery = !this.target.rawQuery;\n  }\n\n  onChangeInternal() {\n    this.checkIsNull();\n    this.panelCtrl.refresh(); // Asks the panel to refresh data.\n  }\n  \n  // 校验页面可输入参数，防止脏乱\n  checkIsNull(){\n    var re = new RegExp(\"^[ ]+$\");\n    if(!this.target.project || this.target.project == \"null\" \n      || this.target.project == \" \" || this.target.project == '\"\"' \n      || re.test(this.target.project)){\n      this.target.project = \"\";\n    }\n    if(!this.target.metric || this.target.metric == \"null\" \n      || this.target.metric == \" \" || this.target.metric == '\"\"' \n      || re.test(this.target.metric)){\n      this.target.metric = \"\";\n    }\n    if(!this.target.period || this.target.period == \"null\" \n      || this.target.period == \" \" || this.target.period == '\"\"' \n      || re.test(this.target.period)){\n      this.target.period = \"\";\n    }\n    if(!this.target.group || this.target.group == \"null\" \n      || this.target.group == \" \" || this.target.group == '\"\"' \n      || re.test(this.target.group)){\n      this.target.group = \"\";\n    };\n    if(!this.target.dimensions || this.target.dimensions == \"null\" \n      || this.target.dimensions == \" \" || this.target.dimensions == '\"\"' \n      || re.test(this.target.dimensions)){\n      this.target.dimensions = \"\";\n    }\n    if(!this.dimensions || this.dimensions == \"null\" \n      || this.dimensions == \" \" || this.dimensions == '\"\"' \n      || re.test(this.dimensions)){\n      this.dimensions = \"\";\n    }\n    if(!this.target.ycol || this.target.ycol == \"null\" \n      || this.target.ycol == \" \" || this.target.ycol == '\"\"' \n      || re.test(this.target.ycol)){\n      this.target.ycol = \"\";\n    }\n    if(!this.statistics || this.statistics == \"null\" \n      || this.statistics == \" \" || this.statistics == '\"\"' \n      || re.test(this.statistics)){\n      this.statistics = \"\";\n    }\n    if(!this.target.xcol || this.target.xcol == \"null\" \n      || this.target.xcol == \" \" || this.target.xcol == '\"\"' \n      || re.test(this.target.xcol)){\n      this.target.xcol = \"\";\n    }\n    if(!this.target.describe || this.target.describe == \"null\" \n      || this.target.describe == \" \" || this.target.describe == '\"\"' \n      || re.test(this.target.describe)){\n      this.target.describe = \"\";\n    }\n  }\n}\n\nGenericDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\n\n"]}